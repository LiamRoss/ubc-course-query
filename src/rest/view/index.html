<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">

    <title>UBC Class UI - Team 46</title>

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, shrink-to-fit=no, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <!--<base href="src/rest/view/">-->

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>

    <!-- NAVBAR CSS -->
    <!-- TODO: implement once made -->
    <!--<link href="stylesheets/style.css" rel="stylesheet">-->

    <!-- MAIN PAGE STYLE SHEET -->
    <!--<link href="../cpsc310project_team46/blob/master/src/rest/css/style.css" rel="stylesheet">-->

    <!-- BOOTSTRAP STYLE SHEET -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
        crossorigin="anonymous">

    <style type="text/css">
        /*WRAPPER*/
        /*MAIN WRAPPER*/

        #main-wrapper {
            margin-top: 50px;
            padding-top: 5px;
            height: calc(100vh - 50px);
            overflow: auto;
        }
        /*TODO: remove when not needed for testing*/

        #txtQuery {
            height: 300px;
            width: 100%;
        }

        #currentID-selector {
            margin-bottom: 10px;
        }

        .filter {
            border-radius: 4px;
            /*height: 300px;*/
            width: 100%;
            padding: 4px;
            padding-bottom: 0px;
            margin-bottom: 4px;
            border: 1px solid #ccc;
            overflow: hidden;
        }

        .filter-color-0 {
            background-color: #fff;
        }

        .filter-color-1 {
            background-color: #f8f8f8;
        }

        .comparison-override {
            border: none;
            padding-left: 0px;
            background-color: transparent;
        }

        .filter-selector {
            margin-bottom: 4px;
            margin-right: 4px;
        }

        .comparison-selector {
            margin-bottom: 4px;
            margin-right: 4px;
        }

        .form-control {
            padding-top: 3px;
            padding-bottom: 3px;
            height: 32px;
        }

        .input-group-addon {
            padding-top: 3px;
            padding-bottom: 3px;
            height: 32px;
        }

        #placeholder {
            color: gray;
        }

        .internal-wrappers {
            padding: 5px 10px 5px 10px;
            overflow: hidden;
            width: 100%;
        }

        .colour-wrappers {
            padding: 10px 10px 10px 10px;
            overflow: hidden;
            width: 100%;
            background-color: #f8f8f8;
            border: 1px solid #e7e7e7;
        }

        .float-left {
            float: left;
        }

        .float-right {
            float: right;
        }

        #btnUpload {
            padding-top: 7px;
            padding-bottom: 7px;
        }

        #btnSubmit {
            padding-top: 7px;
            padding-bottom: 6px;
            margin-top: 6px;
        }

        #results-table {
            border-radius: 4px 4px 0 0;
            background-color: #fff;
            margin-top: 61px;
        }

        #tblResults {
            border: 1px solid #e7e7e7;
        }
    </style>

</head>

<body>

    <div id="wrapper">

        <!--NAVBAR-->
        <nav class="navbar navbar-default navbar-fixed-top" id="navbar-wrapper">
            <div class="container-fluid">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar-collapse" aria-expanded="false">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand">UBC Class UI - Team 46</a>
                </div>

                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse" id="bs-navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li class="active"><a href="#">Query</a></li>
                        <li><a href="#">Scheduling</a></li>
                    </ul>
                </div>
                <!-- /.navbar-collapse -->
            </div>
            <!-- /.container-fluid -->
        </nav>

        <!--MAIN-->
        <main id="main-wrapper">
            <!--Upload Interface-->
            <div id="file-upload-wrapper" class="internal-wrappers">
                <div class="colour-wrappers">
                    <input type="file" name="fileUpload" class="float-left btn btn-default" id="fileUpload" />
                    <button class="float-right btn btn-default" id="btnUpload">Upload</button>
                </div>
            </div>
            <!--Courses/Rooms selector-->
            <!--<div id="file-upload-wrapper" class="internal-wrappers">
                <div class="colour-wrappers">
                    <select class="btn btn-default" id="currentID-selector">
                        <option value="" selected id="placeholder">Choose a Database to Query</option>
                        <option value="courses">Courses</option>
                        <option value="rooms">Rooms</option>
                    </select>
                </div>
            </div>-->
            <!--Query Interface-->
            <div id="query-wrapper" class="internal-wrappers">
                <div class="colour-wrappers">
                    <!--ID selector-->
                    <select class="btn btn-default" id="currentID-selector">
                        <option value="" selected id="placeholder">Choose a Database to Query</option>
                        <option value="courses">Courses</option>
                        <option value="rooms">Rooms</option>
                    </select>
                    <!--Query selectors go here-->
                    <div class="filter filter-color-0" id="initial-filter">
                        <select class="btn btn-default filter-selector" id="initial-filter-selector">
                            <option value="" selected id="placeholder">Select a Filter</option>
                            <option value="AND">And</option>
                            <option value="OR">Or</option>
                            <option value="NOT">Not</option>
                            <option value="LT">Less Than (number)</option>
                            <option value="GT">Greater Than (number)</option>
                            <option value="EQ">Equal To (number)</option>
                            <option value="IS-s">Starts with (string)</option>
                            <option value="IS-e">Ends with (string)</option>
                            <option value="IS-c">Contains (string)</option>
                            <option value="IS">Equal To (string)</option>
                        </select>
                    </div>
                    <!--<textarea id="txtQuery">
                        {
                            "WHERE":{
                                "GT":{
                                    "courses_avg":97
                                }
                            },
                            "OPTIONS":{
                                "COLUMNS":[
                                    "courses_dept",
                                    "courses_avg"
                                ],
                                "ORDER":"courses_avg",
                                "FORM":"TABLE"
                            }
                        }
                    </textarea><br />-->
                    <button id="btnSubmit" class="btn btn-default float-right">Submit Query</button>
                    <div id="results-table">
                        <table id="tblResults" class="table table-striped"></table>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <script>
        var currentID = "";

        // calls updateCSS on page load
        window.onload = function() {
            updateCSS();
        };

        // changes the currentID if the selector is changed
        $("#currentID-selector").change(function () {
            // clear query
            $("#initial-filter > .filter").remove();
            // reset initial query selector
            $("#initial-filter select").val("");
            // clear style for courses and rooms
            // $(".courses-selector").removeAttr('style').css("display","");
            // $(".rooms-selector").removeAttr('style').css("width","100px");
            // get value
            var selected = $(this).children(":selected").val();
            currentID = selected;
            updateCSS();
        });

        // updates the css, hiding or revealing courses /rooms information
        function updateCSS() {
            console.log("updating css");
            switch (currentID) {
                case "courses":
                    // enable first selector and Submit Query
                    $("#initial-filter-selector").removeAttr("disabled");
                    $("#btnSubmit").removeAttr("disabled");
                    // show+hide
                    $( ".courses-selector" ).css( "display", "block" );
                    $( ".rooms-selector" ).css( "display", "none" );
                    break;
                case "rooms":
                    // enable first selector and Submit Query
                    $("#initial-filter-selector").removeAttr("disabled");
                    $("#btnSubmit").removeAttr("disabled");
                    // show+hide
                    $( ".courses-selector" ).css( "display", "none" );
                    $( ".rooms-selector" ).css( "display", "block" );
                    break;
                default:
                    // disable first selector and Submit Query
                    $("#initial-filter-selector").attr("disabled", "disabled");
                    $("#btnSubmit").attr("disabled", "disabled");
                    // show+hide
                    $( ".courses-selector" ).css( "display", "none" );
                    $( ".rooms-selector" ).css( "display", "none" );
            } 
        }

        $("#btnUpload").click(function () {
            var fileToLoad = document.getElementById("fileUpload").files[0];
            var fileReader = new FileReader();
            fileReader.readAsArrayBuffer(fileToLoad);

            fileReader.onload = function (evt) {
                var id = fileToLoad.name.split(".")[0];
                var content = evt.target.result;
                var formData = new FormData();
                formData.append('body', new Blob([content]));

                $.ajax({
                    url: 'http://localhost:4321/dataset/' + id,
                    type: 'put',
                    cache: false,
                    data: formData,
                    contentType: false,
                    processData: false
                }).done(function (data) {
                    console.log(fileToLoad.name + " was successfully uploaded.");
                }).fail(function (data) {
                    console.log('ERROR - Failed to upload ' + fileToLoad.name + ". data = " + JSON.stringify(
                        data));
                });
            }
        });

        $('#btnSubmit').click(function () {
            var query = $("#txtQuery").val();
            console.log("query", query);

            $.ajax({
                url: 'http://localhost:4321/query',
                type: 'post',
                data: JSON.stringify(query),
                contentType: 'application/json',
                dataType: 'json'
            }).done(function (data) {
                console.log("Response: ", data);
                generateTable(data.result);

            }).fail(function () {
                console.error("ERROR - Failed to submit query.");
            });

            function generateTable(data) {
                var tbl_body = document.createElement("tbody");
                var odd_even = false;
                console.log("DATA", data);
                $.each(data, function () {
                    var tbl_row = tbl_body.insertRow();
                    tbl_row.className = odd_even ? "odd" : "even";
                    $.each(this, function (k, v) {
                        var cell = tbl_row.insertCell();
                        cell.appendChild(document.createTextNode(v.toString()));
                    })
                    odd_even = !odd_even
                })
                document.getElementById("tblResults").appendChild(tbl_body);
            }
        });

        // $(document).ready(function() {
        // update relevant UI based on filter-selector 
        $(document).on('change', '.filter-selector', function () {
            // $('.filter-selector').on('change', "#appended", function () {
            // $('.filter-selector').change(function () {
            console.log("filter-selector changed, calling function");
            // find parent div id
            var parentId = "#" + $(this).closest("div").prop("id");
            console.log("parent id: " + parentId);
            // find parent filter-color
            var filterColor = "";
            var isLight = $(parentId).hasClass( "filter-color-0" );
            if (isLight) {
                filterColor = "filter-color-1";
            } else {
                filterColor = "filter-color-0";
            }
            // remove existing filters
            $(parentId + " > .filter").remove();
            // get selected element value
            var selected = $(this).children(":selected").val();
            // switch statement for value
            switch (selected) {
                case "AND":
                    // append two unique filters
                    var uniqueId = new Date().getTime().toString() + "AND0";
                    var filter = makeFilter(uniqueId, filterColor);
                    $(filter).appendTo(parentId);
                    var uniqueId = new Date().getTime().toString() + "AND1";
                    var filter = makeFilter(uniqueId, filterColor);
                    $(filter).appendTo(parentId);
                    break;
                case "OR":
                    // append two unique filters
                    var uniqueId = new Date().getTime().toString() + "OR0";
                    var filter = makeFilter(uniqueId, filterColor);
                    $(filter).appendTo(parentId);
                    var uniqueId = new Date().getTime().toString() + "OR1";
                    var filter = makeFilter(uniqueId, filterColor);
                    $(filter).appendTo(parentId);
                    break;
                case "NOT":
                    // append one unique filter
                    var uniqueId = new Date().getTime().toString() + "NOT";
                    var filter = makeFilter(uniqueId, filterColor);
                    $(filter).appendTo(parentId);
                    break;
                case "LT":
                    // append one MComparison selector
                    var uniqueId = new Date().getTime().toString() + "LT";
                    var mc = makeMComparison(uniqueId, "is less than", filterColor);
                    $(mc).appendTo(parentId);
                    break;
                case "GT":
                    // append one MComparison selector
                    var uniqueId = new Date().getTime().toString() + "GT";
                    var mc = makeMComparison(uniqueId, "is greater than", filterColor);
                    $(mc).appendTo(parentId);
                    break;
                case "EQ":
                    // append one MComparison selector
                    var uniqueId = new Date().getTime().toString() + "EQ";
                    var mc = makeMComparison(uniqueId, "is equal to", filterColor);
                    $(mc).appendTo(parentId);
                    break;
                case "IS-s":
                    // append one SComparison selector
                    var uniqueId = new Date().getTime().toString() + "IS-s";
                    var sc = makeSComparison(uniqueId, "starts with", filterColor);
                    $(sc).appendTo(parentId);
                    break;
                case "IS-e":
                    // append one SComparison selector
                    var uniqueId = new Date().getTime().toString() + "IS-e";
                    var sc = makeSComparison(uniqueId, "ends with", filterColor);
                    $(sc).appendTo(parentId);
                    break;
                case "IS-c":
                    // append one SComparison selector
                    var uniqueId = new Date().getTime().toString() + "IS-c";
                    var sc = makeSComparison(uniqueId, "contains", filterColor);
                    $(sc).appendTo(parentId);
                    break;
                case "IS":
                    // append one SComparison selector
                    var uniqueId = new Date().getTime().toString() + "IS";
                    var sc = makeSComparison(uniqueId, "is equal to", filterColor);
                    $(sc).appendTo(parentId);
                    break;
                default:
            }
            updateCSS();
        });

        function makeFilter(uniqueId, filterColor) {
            console.log("creating filter");
            // initialize filter with first uniqueIdModifier
            var filter = '<div class="filter '+ filterColor +'" id="' + uniqueId +
                '"><select class="btn btn-default filter-selector '+ filterColor +'"><option value="" selected id="placeholder">Select a Filter</option><option value="AND">And</option><option value="OR">Or</option><option value="NOT">Not</option><option value="LT">Less Than (number)</option><option value="GT">Greater Than (number)</option><option value="EQ">Equal To (number)</option><option value="IS-s">Starts with (string)</option><option value="IS-e">Ends with (string)</option><option value="IS-c">Contains (string)</option><option value="IS">Equal To (string)</option></select></div>';
            return filter;
        }

        function makeMComparison(uniqueId, compPhrase, filterColor) {
            console.log("creating MComparison");
            // initialize filter with first uniqueIdModifier
            var mc = '<div class="filter '+ filterColor +' comparison-override" id="' + uniqueId +
                '"><select class="btn btn-default comparison-selector float-left '+ filterColor +'"><option value="" selected id="placeholder">Select a Key</option><option class="courses-selector" value="courses_avg">Course average</option><option class="courses-selector" value="courses_pass">Number of passes</option><option class="courses-selector" value="courses_fail">Number of fails</option><option class="courses-selector" value="courses_audit">Number of audits</option><option class="rooms-selector" value="rooms_lat">Latitude of room</option><option class="rooms-selector" value="rooms_lon">Longitude of room</option><option class="rooms-selector" value="rooms_seats">Number of seats in room</option></select><div class="input-group"><span class="input-group-addon" id="basic-addon1">' +
                compPhrase +
                '</span><input type="number" class="form-control" placeholder="Enter Number" aria-describedby="basic-addon1"></div></div>';
            return mc;
        }

        function makeSComparison(uniqueId, compPhrase, filterColor) {
            console.log("creating SComparison");
            // initialize filter with first uniqueIdModifier
            var sc = '<div class="filter '+ filterColor +' comparison-override" id="' + uniqueId +
                '"><select class="btn btn-default comparison-selector float-left '+ filterColor +'"><option value="" selected id="placeholder">Select a Key</option><option class="courses-selector" value="courses_dept">Course department</option><option class="courses-selector" value="courses_id">Course ID</option><option class="courses-selector" value="courses_instructor">Course instructor</option><option class="courses-selector" value="courses_title">Course title</option><option class="courses-selector" value="courses_uuid">Course unique ID</option><option class="rooms-selector" value="rooms_fullname">Room full name</option><option class="rooms-selector" value="rooms_shortname">Room short name</option><option class="rooms-selector" value="rooms_number">Room number</option><option class="rooms-selector" value="rooms_name">Room name</option><option class="rooms-selector" value="rooms_address">Room address</option><option class="rooms-selector" value="rooms_type">Room type</option><option class="rooms-selector" value="rooms_furniture">Room furniture</option><option class="rooms-selector" value="rooms_href">Room href</option></select><div class="input-group"><span class="input-group-addon" id="basic-addon1">' +
                compPhrase +
                '</span><input type="string" class="form-control" placeholder="Enter String" aria-describedby="basic-addon1"></div></div>';
            return sc;
        }
    </script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>

    <!-- File Upload Script -->
    <!--<script src="scripts/fileUpload.js"></script>-->

    <!-- Query Submission Script -->
    <!--<script src="scripts/querySubmit.js"></script>-->

</body>

</html>